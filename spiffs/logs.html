<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Logs - AirMaster Gateway</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #logContainer {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 12px;
      border-radius: 6px;
      max-height: 500px;
      overflow-y: auto;
      margin: 16px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .log-line {
      margin: 2px 0;
      line-height: 1.4;
    }
    
    .log-error { color: #f48771; }
    .log-warn { color: #dcdcaa; }
    .log-info { color: #4ec9b0; }
    .log-debug { color: #9cdcfe; }
    .log-verbose { color: #808080; }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .controls button {
      flex: 0 0 auto;
      padding: 8px 16px;
    }
    
    .controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9em;
    }
    
    #autoScroll {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="card">
    <header>
      <h1>System Logs</h1>
    </header>

    <section>
      <div class="controls">
        <button onclick="refreshLogs()">üîÑ Refresh</button>
        <button onclick="clearLogs()">üóë Clear</button>
        <button onclick="rebootDevice()">üîÑ Reboot Device</button>
        <label>
          <input type="checkbox" id="autoScroll" checked>
          Auto-scroll
        </label>
      </div>
      
      <div id="logContainer">
        <div class="log-line">Loading logs...</div>
      </div>
    </section>

    <footer>
      <button onclick="location.href='/'">‚Üê Back</button>
    </footer>
  </div>

  <script>
    let autoScroll = true;
    let logOffset = 0;
    let isLoading = false;
    
    document.getElementById('autoScroll').addEventListener('change', (e) => {
      autoScroll = e.target.checked;
    });
    
    function scrollToBottom() {
      if (autoScroll) {
        const container = document.getElementById('logContainer');
        container.scrollTop = container.scrollHeight;
      }
    }
    
    function formatLogLine(line) {
      // Colorize log levels
      if (line.includes('E (')) return `<div class="log-line log-error">${escapeHtml(line)}</div>`;
      if (line.includes('W (')) return `<div class="log-line log-warn">${escapeHtml(line)}</div>`;
      if (line.includes('I (')) return `<div class="log-line log-info">${escapeHtml(line)}</div>`;
      if (line.includes('D (')) return `<div class="log-line log-debug">${escapeHtml(line)}</div>`;
      if (line.includes('V (')) return `<div class="log-line log-verbose">${escapeHtml(line)}</div>`;
      return `<div class="log-line">${escapeHtml(line)}</div>`;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function refreshLogs() {
      if (isLoading) return;
      isLoading = true;
      
      try {
        const response = await fetch('/api/logs');
        if (response.ok) {
          const data = await response.json();
          const container = document.getElementById('logContainer');
          
          if (data.logs && data.logs.length > 0) {
            container.innerHTML = data.logs.map(formatLogLine).join('');
            logOffset = data.logs.length;
          } else {
            container.innerHTML = '<div class="log-line">No logs available</div>';
          }
          
          scrollToBottom();
        } else {
          console.error('Failed to fetch logs:', response.status);
        }
      } catch (error) {
        console.error('Error fetching logs:', error);
        document.getElementById('logContainer').innerHTML = 
          '<div class="log-line log-error">Failed to load logs</div>';
      } finally {
        isLoading = false;
      }
    }
    
    function clearLogs() {
      fetch('/api/logs/clear', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            document.getElementById('logContainer').innerHTML = 
              '<div class="log-line">Logs cleared</div>';
            logOffset = 0;
          }
        })
        .catch(error => console.error('Error clearing logs:', error));
    }
    
    function rebootDevice() {
      if (confirm('Are you sure you want to reboot the device?')) {
        fetch('/api/reboot', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.ok) {
              document.getElementById('logContainer').innerHTML = 
                '<div class="log-line">Device rebooting...</div>';
            }
          })
          .catch(error => console.error('Error rebooting device:', error));
      }
    }
    
    // Auto-refresh logs every 2 seconds
    setInterval(refreshLogs, 2000);
    
    // Initial load
    refreshLogs();
  </script>
</body>
</html>
