<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Logs - AirMaster Gateway</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #logContainer {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 12px;
      border-radius: 6px;
      max-height: 500px;
      overflow-y: auto;
      margin: 16px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .log-line {
      margin: 2px 0;
      line-height: 1.4;
    }
    
    .log-error { color: #f48771; }
    .log-warn { color: #dcdcaa; }
    .log-info { color: #4ec9b0; }
    .log-debug { color: #9cdcfe; }
    .log-verbose { color: #808080; }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .controls button {
      flex: 0 0 auto;
      padding: 8px 16px;
    }
    
    .controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9em;
    }
    
    #autoScroll {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="card">
    <header>
      <h1>System Logs</h1>
    </header>

    <nav class="tabs">
      <a class="tab" href="/">Status</a>
      <a class="tab" href="/sensor">Sensor</a>
      <a class="tab" href="/settings">Settings</a>
      <a class="tab" href="/ota">System</a>
      <a class="tab active" href="/logs">Logs</a>
    </nav>

    <section>
      <div class="controls">
        <button id="pauseBtn">‚è∏ Pause</button>
        <button onclick="clearLogs()">üóë Clear</button>
        <label>
          <input type="checkbox" id="autoScroll" checked>
          Auto-scroll
        </label>
        <label>
          <input type="checkbox" id="debugMode">
          Debug Logs
        </label>
      </div>
      
      <div id="logContainer">
        <div class="log-line">Loading logs...</div>
      </div>
    </section>

  </div>

  <script>
    let autoScroll = true;
    let logOffset = 0;
    let isLoading = false;
    let isPaused = false;
    
    document.getElementById('autoScroll').addEventListener('change', (e) => {
      autoScroll = e.target.checked;
    });

    document.getElementById('pauseBtn').addEventListener('click', () => {
      isPaused = !isPaused;
      const btn = document.getElementById('pauseBtn');
      btn.textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏ Pause';
    });
    
    document.getElementById('debugMode').addEventListener('change', async (e) => {
      try {
        const response = await fetch('/api/debug', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: e.target.checked })
        });
        if (!response.ok) {
          e.target.checked = !e.target.checked;
          console.error('Failed to set debug mode');
        }
      } catch (error) {
        e.target.checked = !e.target.checked;
        console.error('Error setting debug mode:', error);
      }
    });
    
    function scrollToBottom() {
      if (autoScroll) {
        const container = document.getElementById('logContainer');
        container.scrollTop = container.scrollHeight;
      }
    }
    
    function formatLogLine(log) {
      // Handle both old string format and new object format
      if (typeof log === 'string') {
        return `<div class="log-line">${escapeHtml(log)}</div>`;
      }
      
      // New structured format
      if (!log || typeof log !== 'object') {
        return '<div class="log-line log-error">Invalid log format</div>';
      }
      
      const timestamp = formatTimestamp(log.timestamp || '');
      const message = escapeHtml(log.message || '');
      const level = log.level || 'I';
      
      // Choose color based on log level
      let colorClass = 'log-info';
      switch (level) {
        case 'E': colorClass = 'log-error'; break;
        case 'W': colorClass = 'log-warn'; break;
        case 'I': colorClass = 'log-info'; break;
        case 'D': colorClass = 'log-debug'; break;
        case 'V': colorClass = 'log-verbose'; break;
      }
      
      return `<div class="log-line ${colorClass}">${timestamp} ${message}</div>`;
    }
    
    function formatTimestamp(isoStr) {
      // Parse ISO 8601 duration: P[n]DT[n]H[n]M[n].[n]S or PT[n]H[n]M[n].[n]S
      let match = isoStr.match(/P(\d+)DT(\d+)H(\d+)M([\d.]+)S/);
      if (match) {
        const [_, days, hours, minutes, seconds] = match;
        return `[${days}d ${hours.padStart(2,'0')}:${minutes.padStart(2,'0')}:${Math.floor(seconds).toString().padStart(2,'0')}]`;
      }
      
      match = isoStr.match(/PT(\d+)H(\d+)M([\d.]+)S/);
      if (match) {
        const [_, hours, minutes, seconds] = match;
        return `[${hours.padStart(2,'0')}:${minutes.padStart(2,'0')}:${Math.floor(seconds).toString().padStart(2,'0')}]`;
      }
      
      return isoStr;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function refreshLogs() {
      if (isPaused) return;
      if (isLoading) return;
      isLoading = true;
      
      try {
        const response = await fetch('/api/logs');
        if (response.ok) {
          const data = await response.json();
          const container = document.getElementById('logContainer');
          
          if (data.logs && data.logs.length > 0) {
            container.innerHTML = data.logs.map(formatLogLine).join('');
            logOffset = data.logs.length;
          } else {
            container.innerHTML = '<div class="log-line">No logs available</div>';
          }
          
          scrollToBottom();
        } else {
          console.error('Failed to fetch logs:', response.status);
        }
      } catch (error) {
        console.error('Error fetching logs:', error);
        console.error('Error details:', error.stack);
        document.getElementById('logContainer').innerHTML = 
          `<div class="log-line log-error">Failed to load logs: ${escapeHtml(error.message)}</div>`;
      } finally {
        isLoading = false;
      }
    }
    
    function clearLogs() {
      fetch('/api/logs/clear', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.ok) {
            document.getElementById('logContainer').innerHTML = 
              '<div class="log-line">Logs cleared</div>';
            logOffset = 0;
          }
        })
        .catch(error => console.error('Error clearing logs:', error));
    }
    
    // Auto-refresh logs every 2 seconds
    setInterval(refreshLogs, 2000);
    
    // Initial load
    refreshLogs();
  </script>
</body>
</html>
